from protein_complex_converter.parser import parse_complex_tab, convert_to_mitab, Row, MitabRow, serialize_to_mitab


def test_parse_complex_tab():
    ct = """#Complex ac	Recommended name	Aliases for complex	Taxonomy identifier	Identifiers (and stoichiometry) of molecules in complex	Evidence Code	Experimental evidence	Go Annotations	Cross references	Description	Complex properties	Complex assembly	Ligand	Disease	Agonist	Antagonist	Comment	Source	Expanded participant list
CPX-1	SMAD2-SMAD3-SMAD4 complex	SMAD2/SMAD3/SMAD4 transcription factor complex	9606	P84022(1)|Q13485(1)|Q15796(1)	ECO:0005547(biological system reconstruction evidence based on inference from background scientific knowledge used in manual assertion)	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	pubmed:16322555(see-also)|complex portal:CPX-1(complex-primary)|wwpdb:1U7V(subset)	A transcription factor complex which binds to the promoters of target genes and recruits co-activators and histone acetyltransferases, such as p300, CBP and P300/CBP-associated factor, facilitating transcription. In response to TGF-beta/activin-family protein binding, TGF-beta type II receptors phosphorylate TGF-beta type I receptors (ALK4, 5 and 7) which in turn phosphorylates SMAD2 on two Ser-465 and Ser-467, and SMAD3 on Ser-423 and Ser-425. This enables binding to SMAD4 to form heteromeric SMAD complexes that enter the nucleus to initiate gene transcription. Because of their relatively low DNA-binding affinity, SMAD complexes interact with a wide variety of DNA-binding proteins. Crosstalk with other signalling pathways and interaction with other DNA-binding cofactors define the specific binding patterns of SMADs; in addition, interaction with coactivators/corepressors modulates their transcriptional activity.	Preferential formation of the regulatory R-Smad/SMAD4 heterotrimer over the R-Smad homotrimer is largely enthalpy driven, contributed by the unique presence of strong electrostatic interactions within the heterotrimeric interfaces. These electrostatic interactions exist only in the heterotrimer due to specific charged residues in the SMAD4 subunit, Asp-493 and Arg-378, mediating complementary electrostatic interactions with the neighbouring R-Smad subunits.	Heterotrimer	-	-	-	-	-	psi-mi:"MI:0469"(IntAct)	P84022(1)|Q13485(1)|Q15796(1)"""
    assert parse_complex_tab(ct) == [Row(complex="CPX-1", uniprot_ids=["P84022", "Q13485", "Q15796"], altA="-",altB="-",aliasA="-",aliasB="-",method='psi-mi:"MI:0686"(unspecified method)', first_author_name='Massagué et al. (2005)',pubmed_ids="pubmed:16322555", taxa="-",taxb="taxid:9606(Homo sapiens)",interactiontype="-",source='psi-mi:"MI:0469"(IntAct)', interactionidentifiers="complex portal:CPX-1|wwpdb:1U7V",confidence='-',expansion="bipartite",bio_role_A='psi-mi:"MI:0000"(unspecified)',bio_role_B='psi-mi:"MI:0000"(unspecified)',exp_role_A='psi-mi:"MI:0000"(unspecified)',exp_role_B='psi-mi:"MI:0000"(unspecified)',interactortype_A='psi-mi:"MI:0315"(protein complex)',interactortype_B=['psi-mi:"MI:0326"(protein)', 'psi-mi:"MI:0326"(protein)', 'psi-mi:"MI:0326"(protein)'],xref_A="-",xref_B="-",xref_interaction="GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)",annotation_A="-",annotation_B="-",annotation_interaction="-",taxid="taxid:9606(Homo sapiens)",params_interaction="-",creation_date="2023/05/30",update_date="2023/05/30",checksum_A='-',checksum_B='-',checksum_interaction='-',negative="False",feature_A="-",feature_B="-",stoichiometry_A="-",stoichiometry_B=[1,1,1],identification_method_A="-",identification_method_B="-")]

def test_multiple_authors():
	ct = """#Complex ac	Recommended name	Aliases for complex	Taxonomy identifier	Identifiers (and stoichiometry) of molecules in complex	Evidence Code	Experimental evidence	Go Annotations	Cross references	Description	Complex properties	Complex assembly	Ligand	Disease	Agonist	Antagonist	Comment	Source	Expanded participant list
CPX-1	SMAD2-SMAD3-SMAD4 complex	SMAD2/SMAD3/SMAD4 transcription factor complex	9606	P84022(1)|Q13485(1)|Q15796(1)	ECO:0005547(biological system reconstruction evidence based on inference from background scientific knowledge used in manual assertion)	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	pubmed:16322555(see-also)|pubmed:17283331(see-also)|pubmed:25416956(see-also)|complex portal:CPX-1(complex-primary)|wwpdb:1U7V(subset)	A transcription factor complex which binds to the promoters of target genes and recruits co-activators and histone acetyltransferases, such as p300, CBP and P300/CBP-associated factor, facilitating transcription. In response to TGF-beta/activin-family protein binding, TGF-beta type II receptors phosphorylate TGF-beta type I receptors (ALK4, 5 and 7) which in turn phosphorylates SMAD2 on two Ser-465 and Ser-467, and SMAD3 on Ser-423 and Ser-425. This enables binding to SMAD4 to form heteromeric SMAD complexes that enter the nucleus to initiate gene transcription. Because of their relatively low DNA-binding affinity, SMAD complexes interact with a wide variety of DNA-binding proteins. Crosstalk with other signalling pathways and interaction with other DNA-binding cofactors define the specific binding patterns of SMADs; in addition, interaction with coactivators/corepressors modulates their transcriptional activity.	Preferential formation of the regulatory R-Smad/SMAD4 heterotrimer over the R-Smad homotrimer is largely enthalpy driven, contributed by the unique presence of strong electrostatic interactions within the heterotrimeric interfaces. These electrostatic interactions exist only in the heterotrimer due to specific charged residues in the SMAD4 subunit, Asp-493 and Arg-378, mediating complementary electrostatic interactions with the neighbouring R-Smad subunits.	Heterotrimer	-	-	-	-	-	psi-mi:"MI:0469"(IntAct)	P84022(1)|Q13485(1)|Q15796(1)"""
	assert parse_complex_tab(ct)[0].first_author_name == "Massagué et al. (2005)|Arai et al. (2007)|Rolland et al. (2014)"

def test_convert_to_mitab():
    ct = """#Complex ac	Recommended name	Aliases for complex	Taxonomy identifier	Identifiers (and stoichiometry) of molecules in complex	Evidence Code	Experimental evidence	Go Annotations	Cross references	Description	Complex properties	Complex assembly	Ligand	Disease	Agonist	Antagonist	Comment	Source	Expanded participant list
CPX-1	SMAD2-SMAD3-SMAD4 complex	SMAD2/SMAD3/SMAD4 transcription factor complex	9606	P84022(1)|Q13485(1)|Q15796(1)	ECO:0005547(biological system reconstruction evidence based on inference from background scientific knowledge used in manual assertion)	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	pubmed:16322555(see-also)|complex portal:CPX-1(complex-primary)|wwpdb:1U7V(subset)	A transcription factor complex which binds to the promoters of target genes and recruits co-activators and histone acetyltransferases, such as p300, CBP and P300/CBP-associated factor, facilitating transcription. In response to TGF-beta/activin-family protein binding, TGF-beta type II receptors phosphorylate TGF-beta type I receptors (ALK4, 5 and 7) which in turn phosphorylates SMAD2 on two Ser-465 and Ser-467, and SMAD3 on Ser-423 and Ser-425. This enables binding to SMAD4 to form heteromeric SMAD complexes that enter the nucleus to initiate gene transcription. Because of their relatively low DNA-binding affinity, SMAD complexes interact with a wide variety of DNA-binding proteins. Crosstalk with other signalling pathways and interaction with other DNA-binding cofactors define the specific binding patterns of SMADs; in addition, interaction with coactivators/corepressors modulates their transcriptional activity.	Preferential formation of the regulatory R-Smad/SMAD4 heterotrimer over the R-Smad homotrimer is largely enthalpy driven, contributed by the unique presence of strong electrostatic interactions within the heterotrimeric interfaces. These electrostatic interactions exist only in the heterotrimer due to specific charged residues in the SMAD4 subunit, Asp-493 and Arg-378, mediating complementary electrostatic interactions with the neighbouring R-Smad subunits.	Heterotrimer	-	-	-	-	-	psi-mi:"MI:0469"(IntAct)	P84022(1)|Q13485(1)|Q15796(1)"""
    assert list(convert_to_mitab(parse_complex_tab(ct))) == [MitabRow(uida="CPX-1",uidb="P84022",altA="-",altB="-",aliasA="-",aliasB="-",method='psi-mi:"MI:0686"(unspecified method)',author="Massagué et al. (2005)",pmids="pubmed:16322555",taxa="-",taxb="taxid:9606(Homo sapiens)",interactiontype="-",sourcedb='psi-mi:"MI:0469"(IntAct)', interactionidentifiers="complex portal:CPX-1|wwpdb:1U7V",confidence='-',expansion="bipartite",bio_role_A='psi-mi:"MI:0000"(unspecified)',bio_role_B='psi-mi:"MI:0000"(unspecified)',exp_role_A='psi-mi:"MI:0000"(unspecified)',exp_role_B='psi-mi:"MI:0000"(unspecified)',interactortype_A='psi-mi:"MI:0315"(protein complex)',interactortype_B='psi-mi:"MI:0326"(protein)',xref_A="-",xref_B="-",xref_interaction="GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)",annotation_A="-",annotation_B="-",annotation_interaction="-",host_org_taxid="taxid:9606(Homo sapiens)",params_interaction="-",creation_date="2023/05/30",update_date="2023/05/30",checksum_A='-',checksum_B='-',checksum_interaction='-',negative="False",feature_A="-",feature_B="-",stoichiometry_A="-",stoichiometry_B=1,identification_method_A="-",identification_method_B="-"),MitabRow(uida="CPX-1",uidb="Q13485",altA="-",altB="-",aliasA="-",aliasB="-",method='psi-mi:"MI:0686"(unspecified method)',author="Massagué et al. (2005)",pmids="pubmed:16322555",taxa="-",taxb="taxid:9606(Homo sapiens)",interactiontype="-",sourcedb='psi-mi:"MI:0469"(IntAct)', interactionidentifiers="complex portal:CPX-1|wwpdb:1U7V",confidence='-',expansion="bipartite",bio_role_A='psi-mi:"MI:0000"(unspecified)',bio_role_B='psi-mi:"MI:0000"(unspecified)',exp_role_A='psi-mi:"MI:0000"(unspecified)',exp_role_B='psi-mi:"MI:0000"(unspecified)',interactortype_A='psi-mi:"MI:0315"(protein complex)',interactortype_B='psi-mi:"MI:0326"(protein)',xref_A="-",xref_B="-",xref_interaction="GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)",annotation_A="-",annotation_B="-",annotation_interaction="-",host_org_taxid="taxid:9606(Homo sapiens)",params_interaction="-",creation_date="2023/05/30",update_date="2023/05/30",checksum_A='-',checksum_B='-',checksum_interaction='-',negative="False",feature_A="-",feature_B="-",stoichiometry_A="-",stoichiometry_B=1,identification_method_A="-",identification_method_B="-"),MitabRow(uida="CPX-1",uidb="Q15796",altA="-",altB="-",aliasA="-",aliasB="-",method='psi-mi:"MI:0686"(unspecified method)',author="Massagué et al. (2005)",pmids="pubmed:16322555",taxa="-",taxb="taxid:9606(Homo sapiens)",interactiontype="-",sourcedb='psi-mi:"MI:0469"(IntAct)', interactionidentifiers="complex portal:CPX-1|wwpdb:1U7V",confidence='-',expansion="bipartite",bio_role_A='psi-mi:"MI:0000"(unspecified)',bio_role_B='psi-mi:"MI:0000"(unspecified)',exp_role_A='psi-mi:"MI:0000"(unspecified)',exp_role_B='psi-mi:"MI:0000"(unspecified)',interactortype_A='psi-mi:"MI:0315"(protein complex)',interactortype_B='psi-mi:"MI:0326"(protein)',xref_A="-",xref_B="-",xref_interaction="GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)",annotation_A="-",annotation_B="-",annotation_interaction="-",host_org_taxid="taxid:9606(Homo sapiens)",params_interaction="-",creation_date="2023/05/30",update_date="2023/05/30",checksum_A='-',checksum_B='-',checksum_interaction='-',negative="False",feature_A="-",feature_B="-",stoichiometry_A="-",stoichiometry_B=1,identification_method_A="-",identification_method_B="-")]

def test_serialize_to_mitab():
    ct = """#Complex ac	Recommended name	Aliases for complex	Taxonomy identifier	Identifiers (and stoichiometry) of molecules in complex	Evidence Code	Experimental evidence	Go Annotations	Cross references	Description	Complex properties	Complex assembly	Ligand	Disease	Agonist	Antagonist	Comment	Source	Expanded participant list
CPX-1	SMAD2-SMAD3-SMAD4 complex	SMAD2/SMAD3/SMAD4 transcription factor complex	9606	P84022(1)|Q13485(1)|Q15796(1)	ECO:0005547(biological system reconstruction evidence based on inference from background scientific knowledge used in manual assertion)	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	pubmed:16322555(see-also)|complex portal:CPX-1(complex-primary)|wwpdb:1U7V(subset)	A transcription factor complex which binds to the promoters of target genes and recruits co-activators and histone acetyltransferases, such as p300, CBP and P300/CBP-associated factor, facilitating transcription. In response to TGF-beta/activin-family protein binding, TGF-beta type II receptors phosphorylate TGF-beta type I receptors (ALK4, 5 and 7) which in turn phosphorylates SMAD2 on two Ser-465 and Ser-467, and SMAD3 on Ser-423 and Ser-425. This enables binding to SMAD4 to form heteromeric SMAD complexes that enter the nucleus to initiate gene transcription. Because of their relatively low DNA-binding affinity, SMAD complexes interact with a wide variety of DNA-binding proteins. Crosstalk with other signalling pathways and interaction with other DNA-binding cofactors define the specific binding patterns of SMADs; in addition, interaction with coactivators/corepressors modulates their transcriptional activity.	Preferential formation of the regulatory R-Smad/SMAD4 heterotrimer over the R-Smad homotrimer is largely enthalpy driven, contributed by the unique presence of strong electrostatic interactions within the heterotrimeric interfaces. These electrostatic interactions exist only in the heterotrimer due to specific charged residues in the SMAD4 subunit, Asp-493 and Arg-378, mediating complementary electrostatic interactions with the neighbouring R-Smad subunits.	Heterotrimer	-	-	-	-	-	psi-mi:"MI:0469"(IntAct)	P84022(1)|Q13485(1)|Q15796(1)"""
    expected = """#uidA	uidB	altA	altB	aliasA	aliasB	method	author	pmids	taxa	taxb	interactionType	sourcedb	interactionIdentifier	confidence	expansion	biological_role_A	biological_role_B	experimental_role_A	experimental_role_B	interactor_type_A	interactor_type_B	xrefs_A	xrefs_B	xrefs_Interaction	Annotations_A	Annotations_B	Annotations_Interaction	Host_organism_taxid	parameters_Interaction	Creation_date	Update_date	Checksum_A	Checksum_B	Checksum_Interaction	Negative	Features_A	Features_B	Stoichiometry_A	Stoichiometry_B	Identification_method_A	Identification_method_B\r
CPX-1	P84022	-	-	-	-	psi-mi:"MI:0686"(unspecified method)	Massagué et al. (2005)	pubmed:16322555	-	taxid:9606(Homo sapiens)	-	psi-mi:"MI:0469"(IntAct)	complex portal:CPX-1|wwpdb:1U7V	-	bipartite	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0315"(protein complex)	psi-mi:"MI:0326"(protein)	-	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	-	-	-	taxid:9606(Homo sapiens)	-	2023/05/30	2023/05/30	-	-	-	False	-	-	-	1	-	-\r
CPX-1	Q13485	-	-	-	-	psi-mi:"MI:0686"(unspecified method)	Massagué et al. (2005)	pubmed:16322555	-	taxid:9606(Homo sapiens)	-	psi-mi:"MI:0469"(IntAct)	complex portal:CPX-1|wwpdb:1U7V	-	bipartite	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0315"(protein complex)	psi-mi:"MI:0326"(protein)	-	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	-	-	-	taxid:9606(Homo sapiens)	-	2023/05/30	2023/05/30	-	-	-	False	-	-	-	1	-	-\r
CPX-1	Q15796	-	-	-	-	psi-mi:"MI:0686"(unspecified method)	Massagué et al. (2005)	pubmed:16322555	-	taxid:9606(Homo sapiens)	-	psi-mi:"MI:0469"(IntAct)	complex portal:CPX-1|wwpdb:1U7V	-	bipartite	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0000"(unspecified)	psi-mi:"MI:0315"(protein complex)	psi-mi:"MI:0326"(protein)	-	-	GO:0006351(transcription, DNA-templated)|GO:0007179(transforming growth factor beta receptor signaling pathway)|GO:0003700(sequence-specific DNA binding transcription factor activity)|GO:0003690(double-stranded DNA binding)|GO:0032924(activin receptor signaling pathway)|GO:0071144(heteromeric SMAD protein complex)	-	-	-	taxid:9606(Homo sapiens)	-	2023/05/30	2023/05/30	-	-	-	False	-	-	-	1	-	-\r
"""
    assert serialize_to_mitab(convert_to_mitab(parse_complex_tab(ct))) == expected